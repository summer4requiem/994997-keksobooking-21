(()=>{"use strict";(()=>{const e=document.body.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__button"),n=document.querySelector("#load-error").content.querySelector(".load-error").cloneNode(!0),r=n.querySelector(".error__button"),d=(e,t,o,n)=>{let r=new XMLHttpRequest;return r.responseType="json",r.open(e,t),r.addEventListener("load",(function(){r.status===window.code.SUCCESS?o(r.response):n("Не удалось отправить данные")})),r.addEventListener("error",(function(){n("Ошибка загрузки данных")})),r.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+r.timeout+" мс")})),r.timeout=1e3,r},i=n=>{t.querySelector(".error__message").textContent=n,e.appendChild(t),o.addEventListener("click",a),o.addEventListener("keydown",l)},a=()=>{e.removeChild(t),o.removeEventListener("click",a),o.removeEventListener("keydown",l)},l=e=>{e.code===window.code.ESC&&a()},c=()=>{e.appendChild(n),r.addEventListener("click",s),r.addEventListener("keydown",u)},s=()=>{e.removeChild(n),r.removeEventListener("click",s),r.removeEventListener("keydown",u)},u=e=>{e.code===window.code.ESC&&s()};window.xhrModule={load:e=>{d("GET","https://21.javascript.pages.academy/keksobooking/data",e,c).send()},upload:(e,t)=>{d("POST","https://21.javascript.pages.academy/keksobooking",t,i).send(e)},onUploadDataErrorShowMessage:i}})(),(()=>{let e=null;window.debounce=t=>(...o)=>{e&&window.clearTimeout(e),e=window.setTimeout((()=>{t(...o)}),300)}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=o=>{const n=e.cloneNode(!0);return n.style.cssText=`left: ${o.location.x}px; top: ${o.location.y}px`,n.querySelector("img").src=o.author.avatar,n.style.alt=o.description,n.addEventListener("click",(function(){let e=t.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),n.classList.add("map__pin--active"),t.appendChild(window.cardModule.createCard(o))})),n};window.pinModule={renderPins:e=>{const n=document.createDocumentFragment();for(let r=0;e.length>5?r<5:r<e.length;r++)n.appendChild(o(e[r])),t.appendChild(n)}}})(),(()=>{const e=document.body.querySelectorAll(".map__filter"),t=document.querySelectorAll(".map__checkbox"),o=document.querySelector(".map__filters");o.addEventListener("change",(function(){let o=[],n=[];e.forEach((e=>{o.push(e.value)})),t.forEach((e=>{e.checked&&n.push(e.value)})),o.push(n),(e=>{let t=e[0],o=e[1],n=e[2],r=e[3],d=e[4],i=window.pinsArray.concat();if(window.updatePins(),window.cardModule.isCardExist(),"any"!==t&&(i=window.pinsArray.filter((e=>e.offer.type===t))),"any"!==o)switch(o){case"low":i=i.filter((e=>e.offer.price<=1e4));break;case"high":i=i.filter((e=>e.offer.price>=5e4));break;default:i=i.filter((e=>e.offer.price>1e4&&e.offer.price<5e4))}if("any"!==n&&(i=i.filter((e=>e.offer.rooms.toString()===n))),"any"!==r&&(i=i.filter((e=>e.offer.guests.toString()===r))),d.length)for(let e=0;e<d.length;e++)i=i.filter((t=>-1===t.offer.features.indexOf(d[e])?null:t.offer.guests));window.pinModule.renderPins(i)})(o)})),window.xhrModule.load((e=>{window.pinsArray=e}))})(),(()=>{const e=document.querySelector(".map__pin--main");window.pinSize={width:e.offsetWidth,height:e.offsetHeight,sharpEnd:22},window.pinSizeMiddle={left:Math.floor(window.pinSize.width/2),top:Math.floor(window.pinSize.height/2)},window.pinAddres={x:parseInt(e.style.left,10)+window.pinSizeMiddle.left,y:parseInt(e.style.top,10)+window.pinSizeMiddle.top+window.pinSize.sharpEnd,defaultY:parseInt(e.style.top,10)+window.pinSizeMiddle.left},window.updatePins=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},window.code={ENTER:"Enter",ESC:"Escape",SUCCESS:200,LEFT_MOUSE:1}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__pin--main"),o=document.querySelectorAll("fieldset"),n=e.querySelector("#address"),r=document.querySelector(".map");e.classList.add("ad-form--disabled"),o.forEach((e=>{e.disabled=!0})),n.value=window.pinAddres.x+", "+window.pinAddres.defaultY;const d=()=>{o.forEach((t=>{t.disabled=!1,r.classList.remove("map--faded"),e.classList.remove("ad-form--disabled")})),window.pinModule.renderPins(window.pinsArray),n.value=window.pinAddres.x+", "+window.pinAddres.y},i=()=>{t.removeEventListener("mousedown",a),t.removeEventListener("keydown",l)},a=e=>{e.buttons===window.code.LEFT_MOUSE&&(d(),i())},l=e=>{e.code===window.code.ENTER&&(d(),i())},c=()=>{t.addEventListener("mousedown",a),t.addEventListener("keydown",l)};c(),window.pageUtilsModule={addMainPinListeners:c}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),o={xLeftMin:Math.floor(0-window.pinSizeMiddle.left),xRightMin:Math.floor(1135+window.pinSizeMiddle.top),yTopMax:130-(window.pinSizeMiddle.left+window.pinSize.sharpEnd),yBottomMax:630-(window.pinSizeMiddle.left+window.pinSize.sharpEnd)},n=(e,t,o)=>e>o?o:e<t?t:e;e.addEventListener("mousedown",(function(r){r.preventDefault();let d={x:r.clientX,y:r.clientY};const i=r=>{const i=d.x-r.clientX,a=d.y-r.clientY;d={x:r.clientX,y:r.clientY};let l=e.offsetLeft-i,c=e.offsetTop-a;e.style.left=n(l,o.xLeftMin,o.xRightMin)+"px",e.style.top=n(c,o.yTopMax,o.yBottomMax)+"px",t.value=l+window.pinSizeMiddle.left+", "+(c+window.pinSizeMiddle.top+window.pinSize.sharpEnd)},a=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mousemove",i)};document.addEventListener("mouseup",a),document.addEventListener("mousemove",i)}))})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=t.querySelector(".popup__close"),n=(e,o)=>{let n=t.querySelector(e);o?n.textContent=o:r(n)},r=e=>{e.classList.add("visually-hidden")},d=()=>{e.removeChild(t),o.removeEventListener("click",d),o.removeEventListener("keydown",i)},i=e=>{e.code===window.code.ESC&&d()},a=()=>{let t=e.querySelector(".popup");t&&(o.removeEventListener("click",d),o.removeEventListener("keydown",i),e.removeChild(t))},l=(e,t,o,n)=>{const r=e%10;if(1!==Math.floor(e%100/10)){if(1===r)return e+" "+t;if(r>1&&r<5)return e+" "+o}return e+" "+n};window.cardModule={createCard:e=>(a(),t.querySelector(".popup__avatar").src=e.author.avatar.length?e.author.avatar:"default.png",n(".popup__title",e.offer.title),n(".popup__text--address",e.offer.address),n(".popup__text--price",e.offer.price+"₽/ночь"),n(".popup__type",e.offer.type),n(".popup__text--time","Заезд до "+e.offer.checkin+" Выезд после "+e.offer.checkout),n(".popup__description",e.offer.description),n(".popup__text--capacity",l(e.offer.rooms,"комната","комнаты","комнат")+" для "+l(e.offer.guests,"гостя","гостей","гостей")),(e=>{const o=t.querySelector(".popup__features");e.length?(o.textContent="",e.forEach((e=>{const t=document.createDocumentFragment(),n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+e),t.appendChild(n),o.appendChild(t),o.classList.remove("visually-hidden")}))):r(o)})(e.offer.features),(e=>{const o=t.querySelector(".popup__photos");e.length?(o.textContent="",e.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.src=e,t.width=40,t.height=45,o.append(t),o.classList.remove("visually-hidden")}))):r(o)})(e.offer.photos),o.addEventListener("click",d),o.addEventListener("keydown",i),t),isCardExist:a}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#title"),o=e.querySelector("#price"),n=e.querySelector("#description"),r=e.querySelector(".ad-form__reset"),d=e.querySelector("#type"),i=e.querySelector("#timein"),a=e.querySelector("#timeout"),l=e.querySelector("#capacity").querySelectorAll("option"),c=e.querySelector("#room_number"),s=e.querySelector("#capacity"),u=document.querySelectorAll("fieldset"),p=document.body.querySelector("main"),m=document.body.querySelector("#housing-type"),f=document.querySelector(".map"),w=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);let y=5e3,v=1e3,h=1e4;const S=(e,t)=>{t.value=e.value};t.addEventListener("input",(function(){let e=t.value.trim();t.value=e;let o=t.minLength-e.length;e.length<30?t.setCustomValidity("Минимальное количество символов: "+t.minLength+" осталось: "+o):100===e.length?t.setCustomValidity("Максимальное количество символов: "+t.maxLength):t.setCustomValidity(""),t.reportValidity()}));const E=()=>{switch(d.value){case"house":o.placeholder=y;break;case"flat":o.placeholder=v;break;case"bungalow":o.placeholder=0;break;case"palace":o.placeholder=h}},_=e=>{e.setCustomValidity("Пожалуйста, заполните поле!")};o.addEventListener("invalid",_(o)),t.addEventListener("invalid",_(t)),o.addEventListener("input",(function(){let e=+o.value;0===e?o.setCustomValidity("Введите число!"):e>1e6?o.setCustomValidity("Максимальная цена за ночь 1 000 000 !"):"house"===d.value&&e<y?o.setCustomValidity("Минимальная стоимость дома не должна быть меньше 5000 руб"):"flat"===d.value&&e<v?o.setCustomValidity("Минимальная стоимость квартиры не должна быть меньше 1000 руб"):"palace"===d.value&&e<h?o.setCustomValidity("Минимальная стоимость дворца не должна быть меньше 10000 руб"):"bungalow"===d.value&&e<0?o.setCustomValidity("Минимальная стоимость бунгало не может быть меньше 0 руб"):o.setCustomValidity(""),o.reportValidity()})),i.addEventListener("change",(function(){S(i,a)})),a.addEventListener("change",(function(){S(a,i)}));const L=()=>{l.forEach((e=>{e.setAttribute("disabled","true"),e.removeAttribute("selected")}));const e=new Set;switch(c.value){case"3":e.add("3");case"2":e.add("2");case"1":e.add("1");break;case"100":e.add("0")}l.forEach((t=>{e.has(t.value)&&t.removeAttribute("disabled")})),s.querySelector("option:not(:disabled)").setAttribute("selected","true")},q=()=>{f.classList.add("map--faded"),e.classList.add("ad-form--disabled"),t.value="",n.value="",o.value="",m.value="any",window.updatePins(),u.forEach((e=>{e.disabled=!0}))},g=e=>{e.key===window.code.ESC&&w.remove(),document.removeEventListener("keydown",g)},C=()=>{w.remove(),w.removeEventListener("click",C)},k=()=>{p.appendChild(w),w.addEventListener("click",C),document.addEventListener("keydown",g),r.removeEventListener("click",q),q(),window.pageUtilsModule.addMainPinListeners()};r.addEventListener("click",q),e.addEventListener("submit",(function(t){t.preventDefault(),window.xhrModule.upload(new FormData(e),k)})),L(),E(),d.addEventListener("change",E),c.addEventListener("change",L)})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=document.querySelector(".ad-form__field").querySelector("input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload").querySelector("input[type=file]"),r=document.querySelector(".ad-form__photo");const d=(t,o)=>{let n=t.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(function(){o(e)})),e.readAsDataURL(t)}};t.addEventListener("change",(function(){let e=t.files[0];d(e,(function(e){o.src=e.result}))})),n.addEventListener("change",(()=>{Array.from(n.files).forEach((e=>{d(e,(function(e){const t=document.createElement("img");t.src=e.result,t.style.width="70px",t.style.height="70px",r.appendChild(t)}))}))}))})()})();