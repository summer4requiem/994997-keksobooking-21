(()=>{"use strict";(()=>{const e=document.body.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__button"),n=document.querySelector("#load-error").content.querySelector(".load-error").cloneNode(!0),r=n.querySelector(".error__button"),d=(e,t,o,n)=>{let r=new XMLHttpRequest;return r.responseType="json",r.open(e,t),r.addEventListener("load",(function(){r.status===window.code.SUCCESS?o(r.response):n("Не удалось отправить данные")})),r.addEventListener("error",(function(){n("Ошибка загрузки данных")})),r.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+r.timeout+" мс")})),r.timeout=1e3,r},i=n=>{t.querySelector(".error__message").textContent=n,e.appendChild(t),o.addEventListener("click",a),o.addEventListener("keydown",c)},a=()=>{e.removeChild(t),o.removeEventListener("click",a),o.removeEventListener("keydown",c)},c=e=>{e.code===window.code.ESC&&a()},l=()=>{e.appendChild(n),r.addEventListener("click",s),r.addEventListener("keydown",u)},s=()=>{e.removeChild(n),r.removeEventListener("click",s),r.removeEventListener("keydown",u)},u=e=>{e.code===window.code.ESC&&s()};window.xhrModule={load:e=>{d("GET","https://21.javascript.pages.academy/keksobooking/data",e,l).send()},upload:(e,t)=>{d("POST","https://21.javascript.pages.academy/keksobooking",t,i).send(e)},onUploadDataErrorShowMessage:i}})(),(()=>{let e=null;window.debounce=t=>(...o)=>{e&&window.clearTimeout(e),e=window.setTimeout((()=>{t(...o)}),500)}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=o=>{const n=e.cloneNode(!0);return n.style.cssText=`left: ${o.location.x}px; top: ${o.location.y}px`,n.querySelector("img").src=o.author.avatar,n.style.alt=o.description,n.addEventListener("click",(()=>{let e=t.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),n.classList.add("map__pin--active"),t.appendChild(window.cardModule.createCard(o))})),n};window.pinModule={renderPins:e=>{const n=document.createDocumentFragment();for(let r=0;e.length>5?r<5:r<e.length;r++)n.appendChild(o(e[r])),t.appendChild(n)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),r=e.querySelector("#housing-price");let d=[];const i=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),a=e=>i(t,e.offer,"type"),c=e=>i(o,e.offer,"rooms"),l=e=>i(n,e.offer,"guests"),s=t=>{const o=e.querySelectorAll("input:checked");return Array.from(o).every((e=>t.offer.features.includes(e.value)))},u=e=>{const t=window.PriceLimit[r.value];return!t||e.offer.price>=t.min&&e.offer.price<=t.max},p=window.debounce((()=>{d=window.pinsArray.slice(0),d=window.pinsArray.filter(a).filter(u).filter(c).filter(l).filter(s),window.pinModule.renderPins(d.slice(0,5))}));e.addEventListener("change",(()=>{window.updatePins(),window.cardModule.isCardExist(),p()})),window.xhrModule.load((e=>{window.pinsArray=e}))})(),(()=>{const e=document.querySelector(".map__pin--main");window.pinSize={width:e.offsetWidth,height:e.offsetHeight,sharpEnd:22},window.pinSizeMiddle={left:Math.floor(window.pinSize.width/2),top:Math.floor(window.pinSize.height/2)},window.pinAddres={x:parseInt(e.style.left,10)+window.pinSizeMiddle.left,y:parseInt(e.style.top,10)+window.pinSizeMiddle.top+window.pinSize.sharpEnd,defaultY:parseInt(e.style.top,10)+window.pinSizeMiddle.left},window.updatePins=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},window.PriceLimit={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},hight:{min:5e4,max:1/0}},window.code={ENTER:"Enter",ESC:"Escape",SUCCESS:200,LEFT_MOUSE:1}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__pin--main"),o=document.querySelectorAll("fieldset"),n=e.querySelector("#address"),r=document.querySelector(".map");e.classList.add("ad-form--disabled"),o.forEach((e=>{e.disabled=!0})),n.value=`${window.pinAddres.x} ${window.pinAddres.defaultY}`;const d=()=>{o.forEach((t=>{t.disabled=!1,r.classList.remove("map--faded"),e.classList.remove("ad-form--disabled")})),window.pinModule.renderPins(window.pinsArray),n.value=`${window.pinAddres.x}, ${window.pinAddres.y}`},i=()=>{t.removeEventListener("mousedown",a),t.removeEventListener("keydown",c)},a=e=>{e.buttons===window.code.LEFT_MOUSE&&(d(),i())},c=e=>{e.code===window.code.ENTER&&(d(),i())},l=()=>{t.addEventListener("mousedown",a),t.addEventListener("keydown",c)};l(),window.pageUtilsModule={addMainPinListeners:l}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),o={xLeftMin:Math.floor(0-window.pinSizeMiddle.left),xRightMin:Math.floor(1135+window.pinSizeMiddle.top),yTopMax:130-(window.pinSizeMiddle.left+window.pinSize.sharpEnd),yBottomMax:630-(window.pinSizeMiddle.left+window.pinSize.sharpEnd)},n=(e,t,o)=>e>o?o:e<t?t:e;e.addEventListener("mousedown",(r=>{r.preventDefault();let d={x:r.clientX,y:r.clientY};const i=r=>{const i=d.x-r.clientX,a=d.y-r.clientY;d={x:r.clientX,y:r.clientY};let c=e.offsetLeft-i,l=e.offsetTop-a;e.style.left=n(c,o.xLeftMin,o.xRightMin)+"px",e.style.top=n(l,o.yTopMax,o.yBottomMax)+"px",t.value=`${c+window.pinSizeMiddle.left}, ${l+window.pinSizeMiddle.top+window.pinSize.sharpEnd}`},a=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mousemove",i)};document.addEventListener("mouseup",a),document.addEventListener("mousemove",i)}))})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),o=t.querySelector(".popup__features"),n=t.querySelector(".popup__close"),r=(e,o)=>{const n=t.querySelector(e);o?n.textContent=o:d(n)},d=e=>{e.classList.add("visually-hidden")},i=()=>{e.removeChild(t),n.removeEventListener("click",i),n.removeEventListener("keydown",a)},a=e=>{e.code===window.code.ESC&&i()},c=(e,t,o,n)=>{const r=e%10;if(1!==Math.floor(e%100/10)){if(1===r)return`${e} ${t}`;if(r>1&&r<5)return`${e} ${o}`}return`${e} ${n}`};window.cardModule={createCard:e=>{var l;return t.querySelector(".popup__avatar").src=e.author.avatar.length?e.author.avatar:"default.png",r(".popup__title",e.offer.title),r(".popup__text--address",e.offer.address),r(".popup__text--price",e.offer.price+" ₽/ночь"),r(".popup__type",e.offer.type),r(".popup__text--time",`Заезд до ${e.offer.checkin} Выезд после ${e.offer.checkout}`),r(".popup__description",e.offer.description),r(".popup__text--capacity",`${c(e.offer.rooms,"комната","комнаты","комнат")} для ${c(e.offer.guests,"гостя","гостей","гостей")}`),(l=e.offer.features).length?(o.textContent="",l.forEach((e=>{const t=document.createDocumentFragment(),n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+e),t.appendChild(n),o.appendChild(t),o.classList.remove("visually-hidden")}))):d(o),(e=>{const o=t.querySelector(".popup__photos");e.length?(o.textContent="",e.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.src=e,t.width=40,t.height=45,o.append(t),o.classList.remove("visually-hidden")}))):d(o)})(e.offer.photos),n.addEventListener("click",i),n.addEventListener("keydown",a),t},isCardExist:()=>{const t=e.querySelector(".popup");t&&(n.removeEventListener("click",i),n.removeEventListener("keydown",a),e.removeChild(t))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__photo"),n=e.querySelector("#title"),r=e.querySelector("#price"),d=e.querySelector("#description"),i=e.querySelector(".ad-form__reset"),a=e.querySelector("#type"),c=e.querySelector("#timein"),l=e.querySelector("#timeout"),s=e.querySelector("#capacity").querySelectorAll("option"),u=e.querySelector("#room_number"),p=e.querySelector("#capacity"),m=document.querySelectorAll("fieldset"),w=document.body.querySelector("main"),y=document.body.querySelector("#housing-type"),f=document.querySelector(".map"),v=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),h=5e3,S=1e3,E=1e4,_=(e,t)=>{t.value=e.value};n.addEventListener("input",(()=>{const e=n.value.trim();n.value=e;const t=n.minLength-e.length;e.length<30?n.setCustomValidity(`Минимальное количество символов: ${n.minLength} осталось: ${t}`):100===e.length?n.setCustomValidity("Максимальное количество символов: "+n.maxLength):n.setCustomValidity(""),n.reportValidity()}));const L=()=>{switch(a.value){case"house":r.placeholder=h;break;case"flat":r.placeholder=S;break;case"bungalow":r.placeholder=0;break;case"palace":r.placeholder=E}},q=e=>{e.setCustomValidity("Пожалуйста, заполните поле!")};r.addEventListener("invalid",q(r)),n.addEventListener("invalid",q(n)),r.addEventListener("input",(()=>{const e=+r.value;let t;t=0===e?"Введите число!":e>1e6?"Максимальная цена за ночь 1 000 000 !":"house"===a.value&&e<h?"Минимальная стоимость дома не должна быть меньше 5000 руб":"flat"===a.value&&e<S?"Минимальная стоимость квартиры не должна быть меньше 1000 руб":"palace"===a.value&&e<E?"Минимальная стоимость дворца не должна быть меньше 10000 руб":"bungalow"===a.value&&e<0?"Минимальная стоимость бунгало не может быть меньше 0 руб":"",r.setCustomValidity(t),r.reportValidity()})),c.addEventListener("change",(()=>{_(c,l)})),l.addEventListener("change",(()=>{_(l,c)}));const g=()=>{s.forEach((e=>{e.setAttribute("disabled","true"),e.removeAttribute("selected")}));const e=new Set;switch(u.value){case"3":e.add("3");case"2":e.add("2");case"1":e.add("1");break;case"100":e.add("0")}s.forEach((t=>{e.has(t.value)&&t.removeAttribute("disabled")})),p.querySelector("option:not(:disabled)").setAttribute("selected","true")},x=()=>{f.classList.add("map--faded"),e.classList.add("ad-form--disabled"),n.value="",d.value="",r.value="",y.value="any",window.updatePins(),(()=>{for(o.innerHtml="",t.src="http://127.0.0.1:5500/img/muffin-grey.svg";o.firstChild;)o.removeChild(o.lastChild)})(),m.forEach((e=>{e.disabled=!0})),window.pageUtilsModule.addMainPinListeners()},M=e=>{"Escape"===e.code&&(C(),document.removeEventListener("keydown",M))},C=()=>{v.remove(),v.removeEventListener("click",C)},k=()=>{w.appendChild(v),v.focus(),v.addEventListener("click",C),document.addEventListener("keydown",M),x()};e.addEventListener("submit",(t=>{t.preventDefault(),window.xhrModule.upload(new FormData(e),k)})),g(),L(),i.addEventListener("click",x),a.addEventListener("change",L),u.addEventListener("change",g)})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field").querySelector("input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload").querySelector("input[type=file]"),r=document.querySelector(".ad-form__photo"),d=(t,o)=>{const n=t.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e)})),e.readAsDataURL(t)}};t.addEventListener("change",(()=>{const e=t.files[0];d(e,(e=>{o.src=e.result}))})),n.addEventListener("change",(()=>{Array.from(n.files).forEach((e=>{d(e,(e=>{const t=document.createElement("img");t.src=e.result,t.style.width="70 px",t.style.height="70 px",r.appendChild(t)}))}))}))})()})();