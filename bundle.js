(()=>{"use strict";(()=>{const e=document.body.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__button"),n=document.querySelector("#load-error").content.querySelector(".load-error").cloneNode(!0),r=n.querySelector(".error__button"),d=(e,t,o,n)=>{let r=new XMLHttpRequest;return r.responseType="json",r.open(e,t),r.addEventListener("load",(()=>{r.status===window.code.SUCCESS?o(r.response):n("Не удалось отправить данные")})),r.addEventListener("error",(()=>{n("Ошибка загрузки данных")})),r.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+r.timeout+" мс")})),r.timeout=1e3,r},i=n=>{t.querySelector(".error__message").textContent=n,e.appendChild(t),o.addEventListener("click",a),o.addEventListener("keydown",l)},a=()=>{e.removeChild(t),o.removeEventListener("click",a),o.removeEventListener("keydown",l)},l=e=>{e.code===window.code.ESC&&a()},s=()=>{e.appendChild(n),r.addEventListener("click",c),r.addEventListener("keydown",u)},c=()=>{e.removeChild(n),r.removeEventListener("click",c),r.removeEventListener("keydown",u)},u=e=>{e.code===window.code.ESC&&c()};window.xhrModule={load:e=>{d("GET","https://21.javascript.pages.academy/keksobooking/data",e,s).send()},upload:(e,t)=>{d("POST","https://21.javascript.pages.academy/keksobooking",t,i).send(e)},onUploadDataErrorShowMessage:i}})(),(()=>{let e=null;window.debounce=t=>(...o)=>{e&&window.clearTimeout(e),e=window.setTimeout((()=>{t(...o)}),500)}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=o=>{const n=e.cloneNode(!0);return n.style.cssText=`left: ${o.location.x}px; top: ${o.location.y}px`,n.querySelector("img").src=o.author.avatar,n.style.alt=o.description,n.addEventListener("click",(()=>{let e=t.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),n.classList.add("map__pin--active"),t.appendChild(window.cardModule.createCard(o))})),n};window.pinModule={renderPins:e=>{const n=document.createDocumentFragment();for(let r=0;e.length>5?r<5:r<e.length;r++)n.appendChild(o(e[r])),t.appendChild(n)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),r=e.querySelector("#housing-price");let d=[];const i=(e,t,o)=>"any"===e.value||e.value===t[o].toString(),a=d=>(e=>i(t,e.offer,"type"))(d)&&(e=>i(o,e.offer,"rooms"))(d)&&(e=>i(n,e.offer,"guests"))(d)&&(t=>{const o=e.querySelectorAll("input:checked");return Array.from(o).every((e=>t.offer.features.includes(e.value)))})(d)&&(e=>{const t=window.PriceLimit[r.value];return!t||e.offer.price>=t.min&&e.offer.price<=t.max})(d),l=window.debounce((()=>{d=window.pinsArray.slice(0);let e=[],t=0;for(let o=0;o<d.length&&t<5;o++){let n=d[o];a(n)&&(e.push(n),t++)}window.pinModule.renderPins(e)}));e.addEventListener("change",(()=>{window.updatePins(),window.cardModule.isCardExist(),l()})),window.xhrModule.load((e=>{window.pinsArray=e}))})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address");window.PriceLimit={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},hight:{min:5e4,max:1/0}},window.formFieldDisabled=(e,t)=>{e.forEach((e=>{e.disabled=t}))},window.setDefaultPinPosition=()=>{e.style.left="570px",e.style.top="375px",t.value=`${window.pinAddres.x}, ${window.pinAddres.defaultY}`},window.pinSize={width:e.offsetWidth,height:e.offsetHeight,sharpEnd:22},window.pinSizeMiddle={left:Math.floor(window.pinSize.width/2),top:Math.floor(window.pinSize.height/2)},window.pinAddres={x:parseInt(e.style.left,10)+window.pinSizeMiddle.left,y:parseInt(e.style.top,10)+window.pinSizeMiddle.top+window.pinSize.sharpEnd,defaultY:parseInt(e.style.top,10)+window.pinSizeMiddle.left},window.updatePins=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},window.code={ENTER:"Enter",ESC:"Escape",SUCCESS:200,LEFT_MOUSE:1}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#address"),o=document.querySelector(".map__pin--main"),n=document.querySelector(".map__filters"),r=document.querySelectorAll("fieldset"),d=n.querySelectorAll("select"),i=document.querySelector(".map");e.classList.add("ad-form--disabled"),n.classList.add("ad-form--disabled"),window.setDefaultPinPosition(),window.formFieldDisabled(r,!0),window.formFieldDisabled(d,!0);const a=()=>{window.formFieldDisabled(r,!1),window.formFieldDisabled(d,!1),i.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),n.classList.remove("ad-form--disabled"),window.pinModule.renderPins(window.pinsArray),t.value=`${window.pinAddres.x}, ${window.pinAddres.y}`},l=()=>{o.removeEventListener("mousedown",s),o.removeEventListener("keydown",c)},s=e=>{e.buttons===window.code.LEFT_MOUSE&&(a(),l())},c=e=>{e.code===window.code.ENTER&&(a(),l())},u=()=>{o.addEventListener("mousedown",s),o.addEventListener("keydown",c)};u(),window.pageUtilsModule={addMainPinListeners:u}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),o={xLeftMin:Math.floor(0-window.pinSizeMiddle.left),xRightMin:Math.floor(1135+window.pinSizeMiddle.top),yTopMax:130-(window.pinSizeMiddle.left+window.pinSize.sharpEnd),yBottomMax:630-(window.pinSizeMiddle.left+window.pinSize.sharpEnd)},n=(e,t,o)=>e>o?o:e<t?t:e;e.addEventListener("mousedown",(r=>{r.preventDefault();let d={x:r.clientX,y:r.clientY};const i=r=>{const i=d.x-r.clientX,a=d.y-r.clientY;d={x:r.clientX,y:r.clientY};let l=e.offsetLeft-i,s=e.offsetTop-a;e.style.left=n(l,o.xLeftMin,o.xRightMin)+"px",e.style.top=n(s,o.yTopMax,o.yBottomMax)+"px",t.value=`${l+window.pinSizeMiddle.left}, ${s+window.pinSizeMiddle.top+window.pinSize.sharpEnd}`},a=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mousemove",i)};document.addEventListener("mouseup",a),document.addEventListener("mousemove",i)}))})(),(()=>{const e={palace:"дворец",bungalow:"бунгало",flat:"квартира",house:"дом"},t=document.querySelector(".map__pins"),o=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),n=o.querySelector(".popup__features"),r=o.querySelector(".popup__close"),d=(e,t)=>{const n=o.querySelector(e);t?n.textContent=t:i(n)},i=e=>{e.classList.add("visually-hidden")},a=()=>{t.removeChild(o),r.removeEventListener("click",a),document.removeEventListener("keydown",l)},l=e=>{e.code===window.code.ESC&&a()},s=(e,t,o,n)=>{const r=e%10;if(1!==Math.floor(e%100/10)){if(1===r)return`${e} ${t}`;if(r>1&&r<5)return`${e} ${o}`}return`${e} ${n}`};window.cardModule={createCard:t=>{var c;return o.querySelector(".popup__avatar").src=t.author.avatar.length?t.author.avatar:"default.png",d(".popup__title",t.offer.title),d(".popup__text--address",t.offer.address),d(".popup__text--price",t.offer.price+" ₽/ночь"),d(".popup__type",e[t.offer.type]),d(".popup__text--time",`Заезд до ${t.offer.checkin} Выезд после ${t.offer.checkout}`),d(".popup__description",t.offer.description),d(".popup__text--capacity",`${s(t.offer.rooms,"комната","комнаты","комнат")} для ${s(t.offer.guests,"гостя","гостей","гостей")}`),(c=t.offer.features).length?(n.textContent="",c.forEach((e=>{const t=document.createDocumentFragment(),o=document.createElement("li");o.classList.add("popup__feature","popup__feature--"+e),t.appendChild(o),n.appendChild(t),n.classList.remove("visually-hidden")}))):i(n),(e=>{const t=o.querySelector(".popup__photos");e.length?(t.textContent="",e.forEach((e=>{const o=document.createElement("img");o.classList.add("popup__photo"),o.src=e,o.width=40,o.height=45,t.append(o),t.classList.remove("visually-hidden")}))):i(t)})(t.offer.photos),r.addEventListener("click",a),document.addEventListener("keydown",l),o},isCardExist:()=>{const e=t.querySelector(".popup");e&&(r.removeEventListener("click",a),document.removeEventListener("keydown",l),t.removeChild(e))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters"),o=t.querySelectorAll("select"),n=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo"),d=e.querySelector("#title"),i=e.querySelector("#price"),a=e.querySelector("#description"),l=e.querySelector(".ad-form__reset"),s=e.querySelector("#type"),c=e.querySelector("#timein"),u=e.querySelector("#timeout"),p=e.querySelector("#capacity").querySelectorAll("option"),m=e.querySelector("#room_number"),w=e.querySelector("#capacity"),y=document.querySelectorAll("fieldset"),f=document.body.querySelector("main"),v=document.body.querySelector("#housing-type"),h=document.querySelector(".map"),S=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),E=5e3,_=1e3,L=1e4,q=(e,t)=>{t.value=e.value};d.addEventListener("input",(()=>{const e=d.value.trim();d.value=e;const t=d.minLength-e.length;e.length<30?d.setCustomValidity(`Минимальное количество символов: ${d.minLength} осталось: ${t}`):100===e.length?d.setCustomValidity("Максимальное количество символов: "+d.maxLength):d.setCustomValidity(""),d.reportValidity()}));const g=()=>{switch(s.value){case"house":i.placeholder=E;break;case"flat":i.placeholder=_;break;case"bungalow":i.placeholder=0;break;case"palace":i.placeholder=L}},x=e=>{e.setCustomValidity("Пожалуйста, заполните поле!")};i.addEventListener("invalid",x(i)),d.addEventListener("invalid",x(d)),i.addEventListener("input",(()=>{const e=+i.value;let t;t=0===e?"Введите число!":e>1e6?"Максимальная цена за ночь 1 000 000 !":"house"===s.value&&e<E?"Минимальная стоимость дома не должна быть меньше 5000 руб":"flat"===s.value&&e<_?"Минимальная стоимость квартиры не должна быть меньше 1000 руб":"palace"===s.value&&e<L?"Минимальная стоимость дворца не должна быть меньше 10000 руб":"bungalow"===s.value&&e<0?"Минимальная стоимость бунгало не может быть меньше 0 руб":"",i.setCustomValidity(t),i.reportValidity()})),c.addEventListener("change",(()=>{q(c,u)})),u.addEventListener("change",(()=>{q(u,c)}));const b=()=>{p.forEach((e=>{e.setAttribute("disabled","true"),e.removeAttribute("selected")}));const e=new Set;switch(m.value){case"3":e.add("3");case"2":e.add("2");case"1":e.add("1");break;case"100":e.add("0")}p.forEach((t=>{e.has(t.value)&&t.removeAttribute("disabled")})),w.querySelector("option:not(:disabled)").setAttribute("selected","true")},M=()=>{h.classList.add("map--faded"),e.classList.add("ad-form--disabled"),t.classList.add("ad-form--disabled"),d.value="",a.value="",i.value="",v.value="any",window.updatePins(),(()=>{for(r.innerHtml="",n.src="http://127.0.0.1:5500/img/muffin-grey.svg";r.firstChild;)r.removeChild(r.lastChild)})(),window.formFieldDisabled(y,!0),window.formFieldDisabled(o,!0),window.pageUtilsModule.addMainPinListeners(),window.setDefaultPinPosition()},C=e=>{"Escape"===e.code&&(k(),document.removeEventListener("keydown",C))},k=()=>{S.remove(),S.removeEventListener("click",k)},A=()=>{f.appendChild(S),S.focus(),S.addEventListener("click",k),document.addEventListener("keydown",C),M()};e.addEventListener("submit",(t=>{t.preventDefault(),window.xhrModule.upload(new FormData(e),A)})),b(),g(),l.addEventListener("click",(e=>{e.preventDefault(),M()})),s.addEventListener("change",g),m.addEventListener("change",b)})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field").querySelector("input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload").querySelector("input[type=file]"),r=document.querySelector(".ad-form__photo"),d=(t,o)=>{const n=t.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e)})),e.readAsDataURL(t)}};t.addEventListener("change",(()=>{const e=t.files[0];d(e,(e=>{o.src=e.result}))})),n.addEventListener("change",(()=>{Array.from(n.files).forEach((e=>{d(e,(e=>{const t=document.createElement("img");t.src=e.result,t.style.width="70 px",t.style.height="70 px",r.appendChild(t)}))}))}))})()})();